<!-- Setup things -->
{% load static %}{% get_static_prefix as STATIC_PREFIX %}<!DOCTYPE HTML>
<head>
  <script src='{{ STATIC_PREFIX }}resources/js/jquery.min.js' type='text/javascript'></script>
  <script src='{{ STATIC_PREFIX }}resources/js/jquery-ui.min.js' type='text/javascript'></script>
  <link rel="stylesheet" href='{{ STATIC_PREFIX }}resources/css/bootstrap.min.css'>

  <script>
    function add_new_subject() {
      var data = {'subject_name': $("#new_subject_name").val()};
      $.post("/setup/add/subject", data, function(resp) {
        $("#alert_field").html(resp["msg"]);

        if (resp["status"] == "success") {
          // clear fields
          $("#new_subject_name").val('');

          // add new row to table
          tr = $(document.createElement("tr"));
          tr.html("<td id=\"subject_" + resp["data"].id + "\">" + resp["data"].id + "</td>" + "<td>" + resp["data"].name + 
            "</td><td><input type=\"submit\" value=\"Remove\" onclick=\"remove_subject(" + resp["data"].id + ")\">" + "</td>");
          $('#new-subject-row').after(tr);
        }
      })
    }

    function remove_subject(id) {
    data = {'id': id}
      $.post("/setup/remove/subject", data, function(resp) {
        $("#alert_field").html(resp["msg"]);
        if (resp["status"] == "success") {
          $("#subject_"+id).closest("tr").remove();
        }
      })
    }

    function add_new_task() {
      var data = {'name': $("#task_name").val(), 'import_path': $("#task_import_path").val()};
      $.post("/setup/add/task", data, function(resp) {
        $("#alert_field").html(resp["msg"]);

        if (resp["status"] == "success") {
          // clear fields
          $("#task_name").val('');
          $("#task_import_path").val('');

          // add new row to table
          tr = $(document.createElement("tr"));
          tr.html("<td id=\"task_" + resp["data"].id + "\">" + resp["data"].id + "</td>" + "<td>" + resp["data"].name + "</td>" + "<td>" + resp["data"].import_path + 
            "</td><td><input type=\"submit\" value=\"Remove\" onclick=\"remove_task(" + resp["data"].id + ")\">" + "</td>");
          $('#new-task-row').after(tr);
        }
      })
    }

    function remove_task(id) {
    data = {'id': id}
      $.post("/setup/remove/task", data, function(resp) {
        $("#alert_field").html(resp["msg"]);
        if (resp["status"] == "success") {
          $("#task_"+id).closest("tr").remove();
        }
      })
    }

    function add_new_system() {
      data = {'name': $("#system_name").val(), "path": $("#system_path").val(), 
        "processor_path": $("#system_processor_path").val()}
      $.post("/setup/add/system", data, function(resp) {
        $("#alert_field").html(resp["msg"]);

        if (resp["status"] == "success") {
          // clear fields
          $("#system_name").val('');
          $("#system_path").val('');
          $("#system_processor_path").val('');

          // add new row to table
          tr = $(document.createElement("tr"));
          tr.html("<td id=\"system_" + resp["data"].id + "\">" + resp["data"].id + "</td>" + "<td>" + resp["data"].name + "</td>" + 
            "<td>" + data["path"] + "</td>" + "<td>" + data["processor_path"] + "</td>" + 
            "<td><input type=\"submit\" value=\"Remove\" onclick=\"remove_system(" + resp["data"].id + ")\">" + "</td>");
          $('#new-system-row').after(tr);
        }
      })
    }

    function remove_system(id) {
      data = {'id': id}
      $.post("/setup/remove/system", data, function(resp) {
        $("#alert_field").html(resp["msg"]);
        if (resp["status"] == "success") {
          $("#system_"+id).closest("tr").remove();
        }
      })
    }

    function store_single_task_import_path(id) {
      console.log('task', id)
      data = {'id': id, "import_path": $("#import_path_task_" + id).val()};
      console.log(data);
      $.post("/setup/update/task_import_path", data, function(resp) {
        $("#alert_field").html(resp["msg"]);
      });
    }

    function store_single_feature_import_path(id) {
      console.log('feature', id);
      data = {'id': id, "import_path": $("#import_path_feature_" + id).val()};
      console.log(data);
      $.post("/setup/update/feature_import_path", data, function(resp) {
        $("#alert_field").html(resp["msg"]);
      });
    }

    function toggle_feature(feature) {
      var data = {'name': feature}
      $.post('setup/update/toggle_features', data, function(resp) {
        $("#alert_field").html(resp["msg"]);
        if ($("#feature_" + feature).val() == "Enable") {

          // Add the id and change the label
          $("#feature_" + feature).val("Disable");
          $("#feature_" + feature).closest("tr").children("td:first").html(resp["id"])
        } else if ($("#feature_" + feature).val() == "Disable") {

          // Remove the id, move to the bottom of the list, change label
          $("#feature_" + feature).val("Enable");
          $("#feature_" + feature).closest("tr").children("td:first").html('--')
          row = $("#feature_" + feature).closest("tr").html();
          $("#feature_" + feature).closest("tr").remove();
          $("#feature-table").append($('<tr>').append(row));
        } else {

          // Just remove
          $("#feature_" + feature).closest("tr").remove();
        }
      })
    }

    function add_new_feature() {
      var data = {'name': $("#new_feature_name").val(), 'import_path': $("#new_feature_path").val()};
      $.post("/setup/add/feature", data, function(resp) {
        $("#alert_field").html(resp["msg"]);

        if (resp["status"] == "success") {
          // clear fields
          $("#new_feature_name").val('');
          $("#new_feature_path").val('');

          // add new row to table
          tr = $(document.createElement("tr"));
          tr.html("<td>" + resp["data"].id + "</td>" + "<td>" + resp["data"].name + "</td>" + "<td>" + 
            "<input type=\"submit\" value=\"Remove\" onclick=\"toggle_feature(\'" + resp["data"].name + "\')\">" + "</td>");
          $('#new-feature-row').after(tr);
        }
      })
    }

    function generic_post(data) {
      $.post("/setup/update/generic", data, function (resp) {
        $("#alert_field").html(resp["msg"]);
      });      
    }

    function save_recording_sys() {
      generic_post({'action': 'save_recording_sys', 
        'selected_recording_sys': $("#recording_sys_make").val(),
      });
    }

    function update_database_path(db_name) {
      generic_post({'action': 'update_database_storage_path',
        'db_name': db_name, 
        'db_storage_path': $("#db_" + db_name + "_path").val()
      });
    }

    function update_built_in_feature_paths() {
      generic_post({'action': 'update_built_in_feature_paths'});
    }

    $(document).ready(function() {
      // initialize the currently selected system parameters
      $("#recording_sys_make").val("{{recording_sys}}");
    });
  </script>
</head>

<body>
  <div class="alert alert-info" role="alert" id="alert_field">
    <!-- TODO make this always on top -->
  </div>

<!--   <input type="button" onclick="$.post('/setup/run_upkeep')" value="Run upkeep tasks"><br> -->
  <h1>Setup</h1>
  <h2>System Configuration</h2>
    Neural recording system: 
    <select id="recording_sys_make">
      {% for sys in recording_sys_options %}
        <option value='{{sys}}'>{{sys}}</option>
      {% endfor %}
    </select>

    <!-- Button to save recording system -->
    <input type="submit" value="Save Recording Sys." onclick="save_recording_sys()">

    <table class="table table-hover table-sm" style="width: auto;">
      <thead>
        <th>Database</th><th>Storage path</th>
        {% for database in databases %}
          <tr>
            <td>{{database.name}}</td>
            <td><input type="text" value="{{database.path}}" id="db_{{database.name}}_path">
              <input type="submit" value="Save" onclick='update_database_path("{{database.name}}")'>
            </td>
          </tr>
        {% endfor %}
      </thead>

      <!-- make a table with the current values  -->
        <!-- stuff['reward_sys'] = dict(version=0)
        stuff['recording_sys'] = dict(make='plexon', mount_point='/storage/plexon')
        stuff['graphics'] = dict(window_start_x=0, window_start_y=0)
        stuff['backup_root'] = dict(root='/backup')
        stuff['plexon IP address'] = dict(addr='10.0.0.13', port=6000)
        stuff['update_rates'] = dict(hdf_hz=60) -->

<!--       <tr>
        <td><input type="submit" value="Add New" onclick="add_new_subject()"></td>
        <td><input type="text"></td>
      </tr> -->

    </table>

  <h2>Subjects</h2>
  <table class="table table-hover table-sm" style="width: auto;" id="subject-table">
    <thead>
      <th>Index</th><th>Name</th>
    </thead>

    <!-- Row to add new subjects -->
    <tr id="new-subject-row">
      <td><input type="submit" value="Add New" onclick="add_new_subject()"></td>
      <td><input type="text" id="new_subject_name"></td>
      <td></td>
    </tr>

    {% for subject in subjects %}
    <tr id="subject_{{subject.id}}">
      <td>{{subject.id}}</td>
      <td>{{subject.name}}</td>
      <td>
        <input type="submit" value="Remove" onclick="remove_subject({{subject.id}})">
      </td>
    </tr>
    {% endfor %}

  </table>


  <h2>Tasks</h2>
  <table class="table table-hover table-sm" style="width: auto;" id="task-table">
    <thead>
      <tr>
        <th>Index</th><th>Task name</th><th>Python path (must be importable)</th>
      </tr>
    </thead>

    <!-- Row to add new tasks -->
    <tr id="new-task-row">
      <td><input type="submit" value="Add New" onclick="add_new_task()"></td>
      <td><input type="text" id="task_name"></td>
      <td><input type="text" id="task_import_path">
      <td></td>
    </tr>

    {% for task in tasks %}
    <tr id="task_{{task.id}}">
      <td>{{task.id}}</td>
      <td>{{task.name}}</td>
      <td>{{task.import_path}}</td>
      <td>
        <input type="submit" value="Remove" onclick="remove_task({{task.id}})">
      </td>
    </tr>
    {% endfor %}

  </table>


  <h2>Data source systems</h2>
  <!-- TODO add table for systems -->
  <table class="table table-hover table-sm" style="width: auto;" id="system-table">
    <thead>
      <tr>
        <th>Index</th><th>System name</th><th>Path where data is generated/saved</th><th>Post-processing function (optional)</th>
      </tr>
    </thead>

    <tr id="new-system-row">
      <td><input type="submit" value="Add New" onclick="add_new_system()"></td>
      <td><input type="text" id="system_name"></td>
      <td><input type="text" id="system_path"></td>
      <td><input type="text" id="system_processor_path"></td>
    </tr>

    {% for system in systems %}
    <tr id="system_{{system.id}}">
      <td>{{system.id}}</td>
      <td>{{system.name}}</td>
      <td>{{system.path}}</td>
      <td>{{system.processor_path}}</td>
      <td><input type="submit" value="Remove" onclick="remove_system({{system.id}})"></td>
    </tr>
    {% endfor %}

  </table>  


  <h2>Features</h2>
  <input type="submit" value="Update built-in feature paths" onclick="update_built_in_feature_paths()"><br>
  <table class="table table-hover table-sm" style="width: auto;" id="feature-table">
    <thead>
      <tr>
        <th>Index</th><th>Feature name</th><th>Python path (must be importable)</th>
      </tr>
    </thead>

    <!-- New feature row -->
    <tr id="new-feature-row">
      <td><input type="submit" value="Add New" onclick="add_new_feature()"></td>
      <td><input type="text" name="name" id="new_feature_name"></td>
      <td><input type="text" id="new_feature_path"></td>
    </tr>

    {% for feature in active_features %}
    <tr>
      <td>{{feature.id}}</td>
      <td>{{feature.name}}</td>
      <td>
        {% if not feature.name in built_in_feature_names %}
          <input type="submit" id="feature_{{feature.name}}" value="Remove" onclick="toggle_feature('{{feature.name}}')">
        {% else %}
          <input type="submit" id="feature_{{feature.name}}" value="Disable" onclick="toggle_feature('{{feature.name}}')">
        {% endif %}
    </tr>
    {% endfor %}

    <!-- Built-in features -->
    {% for feature in built_in_feature_names %}
    {% if feature not in active_feature_names %}
    <tr>
      <td>--</td>
      <td>{{feature}}</td>
      <td><input type="submit" id="feature_{{feature}}" value="Enable" onclick="toggle_feature('{{feature}}')">
    </tr>
    {% endif %}
    {% endfor %}

  </table>

<!--   Enable built-in feature<br><br>
  <form action="/setup/add/enable_features" method="POST">
    {% for feature in built_in_feature_names %}
      <input type="checkbox" name="{{feature}}" value="{{feature}}">{{feature}}<br>
    {% endfor %}
    <input type="submit">
  </form>
 -->
<!--   Add new custom feature<br>
  <form action="/setup/add/new_feature" method="POST">
    Feature name <input type="text" name="name"><br>
    Feature class path (must be importable) <input type="text" name="import_path"><br>
    <input type="submit">
  </form> -->

</body>